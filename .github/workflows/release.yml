name: Build Release

on:
  push:
    tags:
      - 'v*'  # Triggers on v1.0.0, v3.1.0, etc.

permissions:
  contents: write  # Needed to create releases

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Build embedded distribution
        run: python build_embedded.py
      
      - name: Build launcher exe
        run: |
          cd launcher
          go build -ldflags "-H windowsgui -s -w" -o ../dist/kodex/Kodex.exe kodex.go
      
      - name: Create release zip
        run: |
          cd dist
          Compress-Archive -Path kodex -DestinationPath "../kodex-${{ github.ref_name }}-windows.zip"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: kodex-${{ github.ref_name }}-windows.zip
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}  # v3.1.0-beta = prerelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    runs-on: ubuntu-latest
    needs: [build]
    if: success()
    steps:
      - name: Discord notification
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then exit 0; fi
          
          VERSION="${{ github.ref_name }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${VERSION}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/kodex-${VERSION}-windows.zip"
          
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸš€ Kodex ${VERSION} Released!",
              "url": "${RELEASE_URL}",
              "description": "A new version of Kodex is available.\n\n[**Download kodex-${VERSION}-windows.zip**](${DOWNLOAD_URL})",
              "color": 5793266,
              "footer": {"text": "Kodex Release"},
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          
          curl -sf -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
