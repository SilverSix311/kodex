name: Build Release

on:
  push:
    tags:
      - 'v*'  # Triggers on v1.0.0, v3.1.0, etc.

permissions:
  contents: write  # Needed to create releases

jobs:
  notify-start:
    runs-on: ubuntu-latest
    steps:
      - name: Discord â€” Build Started
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then exit 0; fi
          
          VERSION="${{ github.ref_name }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -sf -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"ðŸ”¨ Kodex ${VERSION} â€” Build Started\", \"url\": \"${RUN_URL}\", \"description\": \"Building release...\", \"color\": 16776960, \"footer\": {\"text\": \"Kodex CI\"}, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}"

  build:
    runs-on: windows-latest
    needs: [notify-start]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Build embedded distribution
        run: python build_embedded.py
      
      - name: Build launcher executables
        run: |
          cd launcher
          go build -ldflags "-H windowsgui -s -w" -o ../dist/kodex/Kodex.exe kodex.go
          go build -ldflags "-s -w" -o ../dist/kodex/Kodex-Debug.exe kodex.go
      
      - name: Create release zip
        run: |
          cd dist
          Compress-Archive -Path kodex -DestinationPath "../kodex-${{ github.ref_name }}-windows.zip"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: kodex-${{ github.ref_name }}-windows.zip
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}  # v3.1.0-beta = prerelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-done:
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    steps:
      - name: Discord â€” Build Complete
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          BUILD_STATUS: ${{ needs.build.result }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then exit 0; fi
          
          VERSION="${{ github.ref_name }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${VERSION}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/kodex-${VERSION}-windows.zip"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          if [ "$BUILD_STATUS" = "success" ]; then
            PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "âœ… Kodex ${VERSION} â€” Build Complete!",
              "url": "${RELEASE_URL}",
              "description": "Release is ready!\n\n[**â¬‡ï¸ Download kodex-${VERSION}-windows.zip**](${DOWNLOAD_URL})",
              "color": 5763719,
              "footer": {"text": "Kodex CI"},
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
            )
          else
            PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "âŒ Kodex ${VERSION} â€” Build Failed",
              "url": "${RUN_URL}",
              "description": "Build failed. Check the [workflow run](${RUN_URL}) for details.",
              "color": 15158332,
              "footer": {"text": "Kodex CI"},
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
            )
          fi
          
          curl -sf -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
