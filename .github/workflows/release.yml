name: Build Release

on:
  push:
    branches: [main]  # Pre-release on every push to main
    tags:
      - 'v*'  # Full release on version tags

permissions:
  contents: write  # Needed to create releases

jobs:
  notify-start:
    runs-on: ubuntu-latest
    steps:
      - name: Discord ‚Äî Build Started
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then exit 0; fi
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="dev-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -sf -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"üî® Kodex ${VERSION} ‚Äî Build Started\", \"url\": \"${RUN_URL}\", \"description\": \"Building release...\", \"color\": 16776960, \"footer\": {\"text\": \"Kodex CI\"}, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}"

  build:
    runs-on: windows-latest
    needs: [notify-start]
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            IS_PRERELEASE=$([[ "$VERSION" == *-* ]] && echo "true" || echo "false")
          else
            VERSION="dev-$(echo ${{ github.sha }} | cut -c1-7)"
            IS_PRERELEASE="true"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION (prerelease: $IS_PRERELEASE)"
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Build embedded distribution
        run: python build_embedded.py
      
      - name: Build launcher executables
        run: |
          cd launcher
          go build -ldflags "-H windowsgui -s -w" -o ../dist/kodex/Kodex.exe kodex.go
          go build -ldflags "-s -w" -o ../dist/kodex/Kodex-Debug.exe kodex.go
      
      - name: Create release zip
        shell: pwsh
        run: |
          cd dist
          Compress-Archive -Path kodex -DestinationPath "../kodex-${{ steps.version.outputs.version }}-windows.zip"
      
      - name: Delete existing dev release (if dev build)
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: dev-drprasad/delete-tag-and-release@v1.0
        with:
          tag_name: dev-latest
          github_token: ${{ secrets.GITHUB_TOKEN }}
          delete_release: true
        continue-on-error: true  # Don't fail if it doesn't exist
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'dev-latest' }}
          name: ${{ steps.version.outputs.version }}
          files: kodex-${{ steps.version.outputs.version }}-windows.zip
          generate_release_notes: ${{ startsWith(github.ref, 'refs/tags/') }}
          body: ${{ !startsWith(github.ref, 'refs/tags/') && format('Development build from commit {0}\n\n‚ö†Ô∏è This is a pre-release build for testing. Not recommended for production use.', github.sha) || '' }}
          draft: false
          prerelease: ${{ steps.version.outputs.is_prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-done:
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    steps:
      - name: Discord ‚Äî Build Complete
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          BUILD_STATUS: ${{ needs.build.result }}
          VERSION: ${{ needs.build.outputs.version }}
          IS_PRERELEASE: ${{ needs.build.outputs.is_prerelease }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then exit 0; fi
          
          # For dev builds, use dev-latest tag
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="dev-latest"
          fi
          
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${TAG}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/kodex-${VERSION}-windows.zip"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          if [ "$BUILD_STATUS" = "success" ]; then
            if [ "$IS_PRERELEASE" = "true" ]; then
              EMOJI="üß™"
              TITLE="Pre-release"
              COLOR=16750848
            else
              EMOJI="‚úÖ"
              TITLE="Release"
              COLOR=5763719
            fi
            
            PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "${EMOJI} Kodex ${VERSION} ‚Äî ${TITLE} Ready!",
              "url": "${RELEASE_URL}",
              "description": "[**‚¨áÔ∏è Download kodex-${VERSION}-windows.zip**](${DOWNLOAD_URL})",
              "color": ${COLOR},
              "footer": {"text": "Kodex CI"},
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
            )
          else
            PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "‚ùå Kodex ${VERSION} ‚Äî Build Failed",
              "url": "${RUN_URL}",
              "description": "Build failed. Check the [workflow run](${RUN_URL}) for details.",
              "color": 15158332,
              "footer": {"text": "Kodex CI"},
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
            )
          fi
          
          curl -sf -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
