name: CI ‚Äî Tests & Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Lint with ruff
        run: ruff check src/ tests/
      
      - name: Run tests
        run: pytest --tb=short -q

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install ruff
        run: pip install ruff
      
      - name: Check formatting
        run: ruff check src/ tests/

  notify:
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: always()
    steps:
      - name: Discord notification
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then exit 0; fi
          
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -1 | sed 's/"/\\"/g')
          COMMIT_URL="${{ github.event.head_commit.url }}"
          AUTHOR="${{ github.event.head_commit.author.username }}"
          SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          # Check job results
          TEST="${{ needs.test.result }}"
          LINT="${{ needs.lint.result }}"
          
          if [ "$TEST" = "success" ] && [ "$LINT" = "success" ]; then
            COLOR=3066993
            STATUS="‚úÖ All checks passed"
            EMOJI="üü¢"
          elif [ "$TEST" = "cancelled" ] || [ "$LINT" = "cancelled" ]; then
            COLOR=10070709
            STATUS="‚ö™ Cancelled"
            EMOJI="‚ö™"
          else
            COLOR=15158332
            STATUS="‚ùå Checks failed"
            EMOJI="üî¥"
            [ "$TEST" != "success" ] && STATUS="$STATUS ‚Äî Tests: $TEST"
            [ "$LINT" != "success" ] && STATUS="$STATUS ‚Äî Lint: $LINT"
          fi
          
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "${EMOJI} CI ‚Äî ${SHA}",
              "url": "${{ github.event.head_commit.url }}",
              "description": "**${COMMIT_MSG}**\nby ${AUTHOR}\n\n${STATUS}",
              "color": ${COLOR},
              "footer": {"text": "Kodex CI ¬∑ ${{ github.ref_name }}"},
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          
          curl -sf -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
